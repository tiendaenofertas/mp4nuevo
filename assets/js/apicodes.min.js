/**
 * MP4 Security System - Core Client Logic v2.2
 * Gestiona la comunicaci√≥n segura entre el Dashboard y el Servidor.
 */

$(document).ready(function() {
    "use strict";

    // 1. CONFIGURACI√ìN DE SEGURIDAD GLOBAL (AJAX)
    const csrfToken = $('meta[name="csrf-token"]').attr('content');
    
    $.ajaxSetup({
        headers: {
            'X-CSRF-TOKEN': csrfToken
        },
        cache: false
    });

    // 2. DETECCI√ìN DE HERRAMIENTAS DE DESARROLLADOR (B√°sico)
    const detectDevTools = () => {
        const threshold = 160;
        const widthThreshold = window.outerWidth - window.innerWidth > threshold;
        const heightThreshold = window.outerHeight - window.innerHeight > threshold;
        
        if (widthThreshold || heightThreshold) {
            console.warn("Entorno de administraci√≥n protegido. La inspecci√≥n est√° siendo monitoreada.");
        }
    };
    window.addEventListener('resize', detectDevTools);

    // 3. L√ìGICA DEL GENERADOR
    const $form = $('#generatorForm');
    const $btn = $form.find('.btn-generate');
    const $resultBox = $('#resultBox');
    const $finalLink = $('#finalLink');

    $form.on('submit', function(e) {
        e.preventDefault();
        
        // Deshabilitar UI durante proceso
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Protegiendo enlace...');
        $resultBox.slideUp();

        // Recopilar datos
        const formData = $(this).serialize();

        $.ajax({
            url: 'action.php',
            type: 'POST',
            data: formData,
            dataType: 'json',
            success: function(response) {
                if (response.status === 'success' && response.token) {
                    // Construir URL completa (BaseUrl definida en dashboard.php)
                    const fullUrl = `${baseUrl}/embed.php?data=${response.token}`;
                    
                    $finalLink.val(fullUrl);
                    $('#previewBtn').attr('href', fullUrl);
                    $resultBox.fadeIn(400);
                    
                    // Notificaci√≥n visual de √©xito
                    console.log("%c[Security] Enlace generado y validado satisfactoriamente.", "color: #28a745; font-weight: bold;");
                } else {
                    showError(response.message || 'Error desconocido al generar el token.');
                }
            },
            error: function(xhr) {
                let errorMsg = 'Error de comunicaci√≥n con el servidor.';
                
                if (xhr.status === 403) errorMsg = 'Sesi√≥n de seguridad expirada. Por favor, recarga la p√°gina.';
                if (xhr.status === 429) errorMsg = 'Demasiadas peticiones. Espera un momento.';
                
                showError(errorMsg);
            },
            complete: function() {
                $btn.prop('disabled', false).html('<i class="fas fa-lock me-2"></i> ENCRIPTAR Y GENERAR ENLACE');
            }
        });
    });

    // 4. UTILIDADES DE INTERFAZ
    window.addSub = function() {
        const subId = Date.now();
        const html = `
            <div class="sub-entry" id="sub-${subId}" style="display:none">
                <div class="row g-2">
                    <div class="col-4">
                        <input type="text" name="label[]" class="form-control form-control-sm" placeholder="Idioma">
                    </div>
                    <div class="col-7">
                        <input type="url" name="sub[]" class="form-control form-control-sm" placeholder="URL del subt√≠tulo">
                    </div>
                    <div class="col-1 d-flex align-items-center">
                        <button type="button" onclick="$('#sub-${subId}').fadeOut(200, function(){ $(this).remove(); })" class="btn btn-sm text-danger">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>`;
        $('#subContainer').append(html);
        $(`#sub-${subId}`).fadeIn(300);
    };

    window.copyLink = function() {
        const text = $finalLink.val();
        const $copyBtn = $('.btn-primary');

        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => notifyCopy($copyBtn));
        } else {
            // Fallback para navegadores antiguos o entornos no-HTTPS
            $finalLink.select();
            document.execCommand('copy');
            notifyCopy($copyBtn);
        }
    };

    function notifyCopy($btn) {
        const originalIcon = $btn.html();
        $btn.html('<i class="fas fa-check"></i>').removeClass('btn-primary').addClass('btn-success');
        setTimeout(() => {
            $btn.html(originalIcon).removeClass('btn-success').addClass('btn-primary');
        }, 2000);
    }

    function showError(msg) {
        // Podr√≠as integrar un Toast o Modal aqu√≠
        alert('üõ°Ô∏è Seguridad MP4: ' + msg);
    }
});
